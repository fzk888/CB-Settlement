# 跨境电商收入核算系统 - 产品说明文档

> **版本**: Phase 1 MVP  
> **更新日期**: 2026-02-07

---

## 一、系统概述

### 1.1 产品定位
本系统用于**跨境电商多店铺月度收入核算**，自动解析亚马逊平台账单 CSV 文件，计算各店铺的月度平台净结算金额，并生成汇总报表。

### 1.2 核心功能
| 功能 | 描述 |
|------|------|
| 多语言解析 | 支持英/德/法/日语 CSV 文件自动识别 |
| Transfer 剥离 | 自动排除提现/转账记录，避免重复计算 |
| 数据校验 | 验证 CSV 字段汇总与 Total 字段一致性 |
| 多店铺汇总 | 按店铺、月份、币种生成汇总报表 |
| Excel 导出 | 输出标准化 Excel 报表 |

---

## 二、核算计算逻辑

### 2.1 报表字段计算公式

报表中每个金额列的计算方式如下：

| 报表列名 | 计算公式 | 说明 |
|---------|----------|------|
| **销售收入** | `Product Sales` + `Postage Credits` + `Shipping Credits` + `Gift Wrap Credits` | 包含商品销售和各类邮费/运费返还 |
| **平台费用** | `Selling Fees` + `FBA Fees` + `Other Transaction Fees` | 平台佣金+FBA费用+其他费用（通常为负数） |
| **促销折扣** | `Promotional Rebates` + `Promotional Rebates Tax` | 促销活动产生的折扣（通常为负数） |
| **平台净结算** | `Σ Total` (排除 Transfer/Payout) | 所有参与计算交易的 Total 字段之和 |
| **提现金额** | `Σ Total` (仅 Transfer/Payout) | 仅供参考，不参与收入计算 |

### 2.2 CSV 字段对应关系

| 报表字段 | 英文 CSV 列名 | 德文 CSV 列名 |
|----------|---------------|---------------|
| 商品销售额 | `product sales` | `umsätze` |
| 邮费返还 | `postage credits` | `gutschrift für versandkosten` |
| 运费返还 | `shipping credits` | `versandgutschriften` |
| 礼品包装 | `gift wrap credits` | `gutschriften für geschenkverpackungen` |
| 平台佣金 | `selling fees` | `verkaufsgebühren` |
| FBA费用 | `fba fees` | `gebühren zu versand durch amazon` |
| 促销折扣 | `promotional rebates` | `rabatte aus werbeaktionen` |
| 合计 | `total` | `gesamt` |

### 2.3 核心指标定义

**月度平台净结算金额 (Platform Net Settlement)**

```
平台净结算 = Σ (所有非Transfer/Payout交易的 Total 字段)
```

这是平台实际结算到账户的金额，**不是毛利或净利润**。

### 2.4 排除规则

以下交易类型**不参与**净结算计算：

| 类型 | 英文 | 德语 | 说明 |
|------|------|------|------|
| 提现 | Transfer | Übertragung | 资金转出到银行账户 |
| 付款 | Payout | - | 平台付款操作 |

**识别方式**:
1. `type` 字段包含 Transfer/Payout
2. 或 `order_id` 为空且 `description` 含 "transfer"

### 2.5 计算示例

**示例数据** (2-UK 2025Jul 实际数据):

| CSV字段 | 金额 (GBP) |
|---------|------------|
| Product Sales | 3,405.14 |
| Postage Credits | 48.51 |
| Shipping Credits | 0.00 |
| Gift Wrap Credits | 0.00 |
| **销售收入合计** | **3,453.65** |

| CSV字段 | 金额 (GBP) |
|---------|------------|
| Selling Fees | -449.66 |
| FBA Fees | -949.61 |
| Other Transaction Fees | -27.68 |
| **平台费用合计** | **-1,426.95** |

| CSV字段 | 金额 (GBP) |
|---------|------------|
| Promotional Rebates | -31.76 |

**平台净结算**: 所有非 Transfer 交易的 `Total` 字段求和 = **1,715.74 GBP**

**提现金额**: 3 笔 Transfer 记录的 Total 合计 = **-937.87 GBP** (仅展示，不参与计算)

---

## 三、数据流程

```
┌─────────────────┐
│  CSV 文件目录    │
│  (多店铺/多月份) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  AmazonCSVParser │ ← 自动识别语言/表头
│  - 字段映射      │
│  - 类型翻译      │
│  - 数值解析      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ RevenueCalculator│ ← 过滤 Transfer
│  - 交易分类      │
│  - 金额汇总      │
│  - 结果校验      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ MonthlyAggregator│ ← 按店铺/月份聚合
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  ExcelExporter   │ → 输出 .xlsx 报表
└─────────────────┘
```

---

## 四、目录结构

```
d:/app/收入核算系统/
├── src/                    # 核心源码
│   ├── models/             # 数据模型
│   │   ├── transaction.py  # 交易记录模型
│   │   ├── store.py        # 店铺/结果模型
│   │   └── report.py       # 报表相关模型
│   ├── parser/             # 解析器
│   │   └── amazon_parser.py # 亚马逊CSV解析(多语言)
│   ├── calculator/         # 核算引擎
│   │   ├── revenue_calculator.py # 收入计算
│   │   └── aggregator.py   # 多店铺聚合
│   ├── reporter/           # 报表生成
│   │   └── excel_exporter.py # Excel导出
│   └── main.py             # 主程序入口
│
├── run_phase1.py           # 启动脚本
├── output/                 # 报表输出目录
├── docs/                   # 文档目录
└── 跨境电商数据/            # 数据源目录
```

---

## 五、使用指南

### 5.1 环境准备
```bash
pip install pandas xlsxwriter
```

### 5.2 数据准备
将亚马逊月度交易 CSV 文件放入：
```
d:/app/收入核算系统/跨境电商数据/部分店铺收入/亚马逊/
```

**文件命名建议**: `店铺名_站点 年月MonthlyTransaction.csv`  
示例: `账号1-UK 2025NovMonthlyTransaction.csv`

### 5.3 运行核算
```bash
cd d:/app/收入核算系统
python run_phase1.py
```

### 5.4 查看结果
报表输出至: `output/月度核算报表_Phase1.xlsx`

---

## 六、支持的语言/站点

| 站点 | 语言 | 支持状态 |
|------|------|----------|
| UK/US/CA/AU | 英语 | ✅ 完全支持 |
| DE | 德语 | ✅ 完全支持 |
| FR | 法语 | ✅ 完全支持 |
| JP | 日语 | ✅ 完全支持 |
| ES/IT | 西/意语 | ⚠️ 待添加 |

---

## 七、常见问题

### Q1: 为什么有"校验警告"？
**原因**: 某些 CSV 文件包含系统未映射的列（如特定地区的税费字段），导致手动汇总与 Total 不一致。  
**影响**: **不影响核心数据**。系统使用 CSV 原始 Total 字段，而非手动求和。

### Q2: Transfer 金额去哪了？
Transfer/Payout 是资金转出操作，**不是收入**。系统自动排除以避免重复计算。

### Q3: 如何区分不同币种？
系统根据文件名中的站点标识（UK/DE/JP 等）自动识别币种，并在报表中分别显示。

---

## 八、后续规划 (Phase 2)

| 功能 | 描述 |
|------|------|
| 仓库费用对接 | 导入仓储账单，计算仓储成本 |
| 采购成本 | 对接 ERP 系统获取 COGS |
| 汇率转换 | 支持多币种转换为人民币 |
| 真实利润 | 计算毛利率、净利润 |
